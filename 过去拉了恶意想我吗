å½“ç„¶å¯ä»¥ ğŸ‘
ä¸‹é¢æˆ‘ç»™ä½ çš„æ˜¯ä¸€ä»½ ã€Œä¸ç”¨ handler_nameã€ç›´æ¥ç”¨ ClassName + è‡ªåŠ¨å‘ç° + fail-fast æ ¡éªŒã€çš„å®Œæ•´æœ€å°å¯è¿è¡Œç‰ˆæœ¬ã€‚
ä½ å¯ä»¥ ç›´æ¥ç…§è¿™ä¸ªç»“æ„æ‹·è¿›å»è·‘ã€‚

âœ… é¡¹ç›®ç»“æ„ï¼ˆå®Œæ•´ï¼‰

project/
â”œâ”€â”€ main.py
â”œâ”€â”€ flow_engine.py
â”œâ”€â”€ servicenow_client.py
â”œâ”€â”€ flow_config.yaml
â””â”€â”€ handlers/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ base.py
    â”œâ”€â”€ copy_minio.py
    â””â”€â”€ create_bucket.py

1ï¸âƒ£ flow_config.yaml

flows:
  - name: Copy_minio_request_flow
    enable: true
    interval: 5
    listen_on:
      type: RITM
      status: Open
      filter: "catalog_item=minio_copy"
    handler: CopyMinioRequestHandler

  - name: Create_bucket_flow
    enable: true
    interval: 10
    listen_on:
      type: RITM
      status: InProgress
      filter: "catalog_item=create_bucket"
    handler: CreateBucketHandler

2ï¸âƒ£ handlers/base.py

class BaseHandler:
    def handle(self, records: list[dict]):
        raise NotImplementedError

3ï¸âƒ£ handlers/copy_minio.py

from handlers.base import BaseHandler

class CopyMinioRequestHandler(BaseHandler):

    def handle(self, records):
        for r in records:
            print(f"[CopyMinio] handling RITM {r['id']}")

4ï¸âƒ£ handlers/create_bucket.py

from handlers.base import BaseHandler

class CreateBucketHandler(BaseHandler):

    def handle(self, records):
        for r in records:
            print(f"[CreateBucket] handling RITM {r['id']}")

5ï¸âƒ£ handlers/init.pyï¼ˆâš ï¸ å¾ˆå…³é”®ï¼‰

from handlers.copy_minio import CopyMinioRequestHandler
from handlers.create_bucket import CreateBucketHandler

	âœ… è¿™ä¸ªæ–‡ä»¶çš„ä½œç”¨ï¼š
ç¡®ä¿æ‰€æœ‰ handler ç±»åœ¨å¯åŠ¨æ—¶è¢« importï¼Œèƒ½è¢«è‡ªåŠ¨å‘ç°

6ï¸âƒ£ servicenow_client.pyï¼ˆMock ç¤ºä¾‹ï¼‰

import random

class ServiceNowClient:

    def query_ritm(self, *, status: str, filter: str) -> list[dict]:
        # mock ServiceNow API
        if random.choice([True, False]):
            return [
                {"id": f"RITM{random.randint(1000,9999)}", "status": status}
            ]
        return []

7ï¸âƒ£ flow_engine.pyï¼ˆâœ… æ ¸å¿ƒï¼‰

import time
import yaml
import schedule
import logging

from handlers.base import BaseHandler
import handlers  # noqa: F401 è§¦å‘ handler import

from servicenow_client import ServiceNowClient


logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)


def build_handler_registry():
    registry = {}

    for cls in BaseHandler.__subclasses__():
        registry[cls.__name__] = cls

    return registry


class FlowEngine:

    def __init__(self, config_path: str):
        self.config = self._load_config(config_path)
        self.handler_registry = build_handler_registry()
        self.sn_client = ServiceNowClient()

        self._validate_flows()

    def _load_config(self, path: str) -> dict:
        with open(path) as f:
            return yaml.safe_load(f)

    def _validate_flows(self):
        errors = []

        for flow in self.config.get("flows", []):
            handler_name = flow.get("handler")
            flow_name = flow.get("name", "<unknown>")

            if handler_name not in self.handler_registry:
                errors.append(
                    f"Flow '{flow_name}': handler '{handler_name}' not found"
                )

        if errors:
            raise RuntimeError(
                "Flow configuration validation failed:\n"
                + "\n".join(errors)
            )

    def start(self):
        for flow in self.config["flows"]:
            if not flow.get("enable", False):
                continue

            interval = flow["interval"]
            schedule.every(interval).minutes.do(self._run_flow, flow)

        logging.info("FlowEngine started")

        while True:
            schedule.run_pending()
            time.sleep(1)

    def _run_flow(self, flow: dict):
        flow_name = flow["name"]
        logging.info(f"[{flow_name}] polling started")

        listen_on = flow["listen_on"]
        records = self.sn_client.query_ritm(
            status=listen_on["status"],
            filter=listen_on["filter"]
        )

        if not records:
            logging.info(f"[{flow_name}] no new records")
            return

        handler_cls = self.handler_registry[flow["handler"]]
        handler = handler_cls()

        logging.info(f"[{flow_name}] {len(records)} record(s) found")
        handler.handle(records)

8ï¸âƒ£ main.py

from flow_engine import FlowEngine

if __name__ == "__main__":
    engine = FlowEngine("flow_config.yaml")
    engine.start()

âœ… ä½ ç°åœ¨å·²ç»å…·å¤‡çš„èƒ½åŠ›
	â€¢	âœ… è‡ªåŠ¨å‘ç° handler
	â€¢	âœ… YAML é©±åŠ¨ flow
	â€¢	âœ… ClassName ç›´æ¥ç»‘å®š
	â€¢	âœ… å¯åŠ¨å³æ ¡éªŒï¼ˆfail fastï¼‰
	â€¢	âœ… å•çº¿ç¨‹ + scheduleï¼Œæ—¥å¿—ä¸æ··
	â€¢	âœ… æ–°å¢ flow / handler ä¸æ”¹å¼•æ“ä»£ç 

âœ… éªŒè¯ fail-fastï¼ˆä½ å¯ä»¥è¯•è¯•ï¼‰

æŠŠ YAML é‡Œçš„ handler æ”¹æˆä¸€ä¸ªä¸å­˜åœ¨çš„åå­—ï¼š

handler: NotExistHandler

å¯åŠ¨æ—¶ç›´æ¥æŠ¥é”™å¹¶é€€å‡ºï¼š

RuntimeError: Flow configuration validation failed:
Flow 'Copy_minio_request_flow': handler 'NotExistHandler' not found

âœ… è¿™æ­£æ˜¯ä½ è¦çš„æ•ˆæœ

ä¸‹ä¸€æ­¥ï¼ˆä½ ä¸€å¥è¯æˆ‘å°±ç»§ç»­ï¼‰

ä½ ç°åœ¨è¿™ä¸ªéª¨æ¶å·²ç»éå¸¸æ‰å®äº†ï¼Œåé¢å¯ä»¥é¡ºæ»‘åŠ çš„æœ‰ï¼š
	â€¢	ğŸ”¹ æ¯ä¸ª flow ç‹¬ç«‹ loggerï¼ˆè§£å†³ä½ æœ€åˆçš„æ—¥å¿—æ‹…å¿ƒï¼‰
	â€¢	ğŸ”¹ handler å¤±è´¥ä¸å½±å“å…¶ä»– flow
	â€¢	ğŸ”¹ handler è¶…æ—¶ / é‡è¯•
	â€¢	ğŸ”¹ è‡ªåŠ¨æ‰«æ handlers packageï¼ˆä¸ç”¨æ‰‹å†™ __init__.pyï¼‰

ä½ æƒ³å…ˆå¼ºåŒ–å“ªä¸€å—ï¼Ÿ
