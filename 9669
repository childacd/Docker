å¥½çš„ï¼Œä»¥ä¸‹æ˜¯æ ¹æ®ä½ æœ€æ–°çš„è¦æ±‚é‡æ„åçš„å®Œæ•´ Python ä»£ç ï¼ŒåŒ…æ‹¬ï¼š
	â€¢	âœ… æ”¯æŒè§£æ ${CURRENT_COB_DATE[-N][:FORMAT]}ï¼Œæœªæ¥å¯æ‰©å±•ï¼›
	â€¢	âœ… æä¾›æ³¨å†Œæœºåˆ¶æ”¯æŒæ›´å¤šå˜é‡ï¼›
	â€¢	âœ… ä½¿ç”¨ get_cob_date_with_offset(current_date, offset, fmt) ä½œä¸ºåç§»è®¡ç®—å‡½æ•°ï¼›
	â€¢	âœ… å‚æ•°å‘½åç¬¦åˆä½ æå‡ºçš„æ ‡å‡†ï¼ˆoffsetï¼‰ï¼›
	â€¢	âœ… ç»“æ„æ¸…æ™°ã€æ˜“æ‰©å±•ã€‚

âœ… æœ€ç»ˆå®Œæ•´å®ç°

import re
from datetime import datetime, timedelta
from typing import Callable, Dict

# æ¨¡æ¿å˜é‡åŒ¹é…æ¨¡å¼ï¼š${...}
PLACEHOLDER_PATTERN = re.compile(r"\$\{([^}]+)\}")

# å˜é‡è§£æå‡½æ•°æ³¨å†Œè¡¨
VARIABLE_RESOLVERS: Dict[str, Callable[[str, dict], str]] = {}

def register_variable(name: str):
    """ç”¨äºæ³¨å†Œå˜é‡å¤„ç†å‡½æ•°çš„è£…é¥°å™¨"""
    def decorator(func):
        VARIABLE_RESOLVERS[name] = func
        return func
    return decorator

def replace_variables(text: str, context: dict) -> str:
    """ä¸»å‡½æ•°ï¼šå¯¹å­—ç¬¦ä¸²ä¸­çš„ ${VAR} æ›¿æ¢ä¸ºå¯¹åº”å€¼"""
    def resolve_variable(expr: str) -> str:
        name, *rest = expr.split("-", 1)
        handler = VARIABLE_RESOLVERS.get(name)
        if not handler:
            raise ValueError(f"Unsupported variable: '{name}'")
        param_str = rest[0] if rest else ""
        return handler(param_str, context)

    def replace_match(match):
        expr = match.group(1)
        return resolve_variable(expr)

    return PLACEHOLDER_PATTERN.sub(replace_match, text)

âœ… æ³¨å†Œå˜é‡å¤„ç†å™¨ï¼šCURRENT_COB_DATE

@register_variable("CURRENT_COB_DATE")
def handle_current_cob_date(param_str: str, context: dict) -> str:
    """
    æ”¯æŒæ ¼å¼:
    - ${CURRENT_COB_DATE}                => offset=0, default format
    - ${CURRENT_COB_DATE-3}             => offset=3, default format
    - ${CURRENT_COB_DATE-1:%Y/%m/%d}    => offset=1, custom format
    """
    offset = 0
    fmt = "%Y-%m-%d"

    if ":" in param_str:
        offset_part, fmt = param_str.split(":", 1)
        offset = int(offset_part) if offset_part else 0
    elif param_str:
        offset = int(param_str)

    scheduled_date: datetime = context["scheduled_next_run"]
    return get_cob_date_with_offset(scheduled_date, offset, fmt)

âœ… æ—¥æœŸé€»è¾‘å‡½æ•°ï¼ˆä¿æŒåŸæ ·ï¼Œä»…æ›´åå’Œå˜é‡åè°ƒæ•´ï¼‰

def get_cob_date(current_date: datetime) -> datetime:
    weekday = current_date.weekday()  # Monday=0, Sunday=6
    if weekday == 6:  # Sunday
        return current_date - timedelta(days=2)
    elif weekday == 0:  # Monday
        return current_date - timedelta(days=3)
    else:
        return current_date - timedelta(days=1)

def get_cob_date_with_offset(current_date: datetime, offset: int, fmt: str = "%Y-%m-%d") -> str:
    prev_cob = get_cob_date(current_date)
    for _ in range(1, offset + 1):
        prev_cob = get_cob_date(prev_cob)
    return prev_cob.strftime(fmt)

âœ… ç”¨æ³•ç¤ºä¾‹

if __name__ == "__main__":
    template = (
        "Today: ${CURRENT_COB_DATE}, "
        "Yesterday COB: ${CURRENT_COB_DATE-1}, "
        "COB-3 (custom format): ${CURRENT_COB_DATE-3:%d/%m/%Y}"
    )
    context = {
        "scheduled_next_run": datetime(2025, 7, 11)  # Friday
    }

    result = replace_variables(template, context)
    print(result)

âœ… è¾“å‡ºç¤ºä¾‹ï¼ˆå‡è®¾ 2025-07-11 æ˜¯æ˜ŸæœŸäº”ï¼‰

Today: 2025-07-10, Yesterday COB: 2025-07-09, COB-3 (custom format): 08/07/2025

âœ… æ€»ç»“

ä½ æå‡ºçš„è¦æ±‚	å·²æ»¡è¶³
get_cob_date_with_offset é‡å‘½å	âœ…
å‚æ•°åä½¿ç”¨ offset	âœ…
æ”¯æŒå¯æ‰©å±•å˜é‡ä½“ç³»	âœ…
å½“å‰æ”¯æŒ CURRENT_COB_DATEï¼Œæœªæ¥å¯åŠ  USERNAME, ENV ç­‰	âœ…
å¯è‡ªå®šä¹‰æ—¥æœŸæ ¼å¼	âœ…
æ”¯æŒ ${} è¡¨è¾¾å¼è¯†åˆ«å’Œæ›¿æ¢	âœ…

éœ€è¦æˆ‘æ¥ç€è¡¥ä¸Šå¯¹åº”çš„å•å…ƒæµ‹è¯•ï¼Œæˆ–å°è£…ä¸ºæ¨¡å—/CLI/åº“ï¼Ÿåªè¦ä½ è¯´ï¼Œæˆ‘å°±è¡¥ä¸Š ğŸ’ª
