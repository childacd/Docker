ä½ é—®å¾—éå¸¸åˆ°ä½ï¼æˆ‘ä»¬æ‹†æˆå‡ ä¸ªé‡ç‚¹é€ä¸€è§£ç­”ï¼š

ğŸ”¥ ä¸€ã€Swagger UI (FastAPI è‡ªå¸¦)

ä½ è¯´çš„æ²¡é”™ï¼ŒFastAPI é»˜è®¤ä¼šè‡ªåŠ¨ç”Ÿæˆ Swagger æ–‡æ¡£ï¼Œåªè¦è®¿é—®ï¼š

http://<your-server>:<port>/docs

ä½ å¯ä»¥ï¼š
	â€¢	è‡ªåŠ¨çœ‹åˆ°æ‰€æœ‰æ¥å£
	â€¢	å¯ä»¥è‡ªå·±ä¸°å¯Œ è¯·æ±‚ç¤ºä¾‹ï¼ˆExample Valueï¼‰ï¼Œè®© Swagger ç•Œé¢æ›´æ˜“ç”¨

âœ… å¦‚ä½•åœ¨ FastAPI é‡Œæ·»åŠ  Example Value

ä¸¾ä¸ªä¾‹å­ï¼š

from pydantic import BaseModel, Field

class CopyRequest(BaseModel):
    source_type: str = Field(..., example="s3")
    source_bucket: str = Field(..., example="my-source-bucket")
    source_object: str = Field(..., example="my-folder/myfile.txt")
    destination_type: str = Field(..., example="minio")
    destination_bucket: str = Field(..., example="my-destination-bucket")
    destination_object: str = Field(..., example="my-folder/myfile.txt")

è¿™æ ·ä½ è®¿é—® /docs æ—¶ï¼ŒSwagger ä¼šè‡ªåŠ¨æ˜¾ç¤º exampleã€‚

ğŸ”¥ äºŒã€ä½ æåˆ°çš„éœ€æ±‚æ€»ç»“

éœ€æ±‚	è¯´æ˜
ä¸°å¯Œ Swagger Example	ç”¨ Field(..., example=...)
å¢åŠ  list API	æä¾›åˆ—å‡º Bucket å’Œç›®å½•å†…å®¹çš„æ¥å£
æ”¯æŒæ•´ä¸ª Folder copy	é€’å½’åˆ—å‡ºæ–‡ä»¶åï¼Œè‡ªå·±å¾ªç¯ copyï¼ˆSDK æ²¡æœ‰ç°æˆæ”¯æŒæ•´ä¸ªç›®å½• copy çš„ APIï¼‰

âœ… ä¸‰ã€å…³äºé€’å½’ copy çš„é‡ç‚¹

ğŸ‘‰ boto3 å’Œ minio SDK éƒ½ æ²¡æœ‰ç°æˆçš„ â€œcopy folderâ€ æ–¹æ³•

å®ƒä»¬çš„ API åªèƒ½æ“ä½œ objectï¼ˆå•ä¸ªæ–‡ä»¶ï¼‰

	æ‰€ä»¥ï¼š

	â€¢	ä½ éœ€è¦è‡ªå·±é€’å½’åˆ—å‡ºæ‰€æœ‰å¯¹è±¡ï¼ˆboto3 æ”¯æŒåˆ†é¡µæŸ¥è¯¢ï¼ŒMinio SDK ä¹Ÿæ”¯æŒéå†ï¼‰
	â€¢	ç„¶åé€ä¸ªä¸‹è½½ã€ä¸Šä¼ ï¼Œç›¸å½“äºä½ è‡ªå·±å®ç°æ‰¹é‡æ‹·è´é€»è¾‘

âœ… å››ã€è®¾è®¡ä¼˜åŒ–åçš„æ¥å£

ğŸ“¦ æ”¯æŒæ¥å£ï¼š
	â€¢	POST /copy
æ”¯æŒå•ä¸ªæ–‡ä»¶å’Œæ•´ä¸ªæ–‡ä»¶å¤¹é€’å½’å¤åˆ¶
	â€¢	GET /list
æ”¯æŒåˆ—å‡º Bucketã€åˆ—å‡ºè·¯å¾„ä¸‹çš„å¯¹è±¡ï¼ˆå¯ä»¥åŠ  prefix å‚æ•°ï¼‰

âœ… äº”ã€å®Œæ•´ä¼˜åŒ–ç‰ˆè®¾è®¡

æˆ‘å¸®ä½ è®¾è®¡å¦‚ä¸‹ï¼š

1. List Buckets & List Objects

@app.get("/list")
async def list_objects(storage_type: str, bucket: str = None, prefix: str = ""):
    """
    storage_type: 's3' or 'minio'
    bucket: Optional. If not provided, list all buckets.
    prefix: Optional. If provided, list objects under this prefix.
    """
    try:
        if storage_type == "s3":
            if not bucket:
                # List all S3 buckets
                response = s3_client.list_buckets()
                buckets = [b['Name'] for b in response['Buckets']]
                return {"buckets": buckets}

            # List S3 objects
            objects = []
            paginator = s3_client.get_paginator('list_objects_v2')
            for page in paginator.paginate(Bucket=bucket, Prefix=prefix):
                for obj in page.get('Contents', []):
                    objects.append(obj['Key'])
            return {"objects": objects}

        elif storage_type == "minio":
            if not bucket:
                buckets = [b.name for b in minio_client.list_buckets()]
                return {"buckets": buckets}

            # List MinIO objects
            objects = []
            for obj in minio_client.list_objects(bucket, prefix=prefix, recursive=True):
                objects.append(obj.object_name)
            return {"objects": objects}

        else:
            raise ValueError("Unsupported storage type")

    except Exception as e:
        logger.error(f"Error listing objects: {e}")
        logger.error(traceback.format_exc())
        raise HTTPException(status_code=500, detail=str(e))

2. æ”¯æŒå•ä¸ªæ–‡ä»¶ & æ•´ä¸ªæ–‡ä»¶å¤¹ Copy

ä½ å¯ä»¥åŠ ä¸€ä¸ªå‚æ•°ï¼š
	â€¢	copy_type: file æˆ– folder

ç„¶åé€’å½’å¤„ç†ï¼š

@app.post("/copy")
async def copy(copy_request: CopyRequest, copy_type: str = "file"):
    logger.info(f"ğŸ“¥ Received copy request: {copy_request.dict()}, type: {copy_type}")
    try:
        if copy_type == "file":
            logger.info("Copying a single file...")
            copy_single_file(copy_request)
        elif copy_type == "folder":
            logger.info("Copying a folder recursively...")
            copy_folder(copy_request)
        else:
            raise ValueError("Unsupported copy_type")

        logger.info("âœ… Copy completed successfully.")
        return {"message": "Copy successful."}

    except Exception as e:
        logger.error(f"Error during copy: {e}")
        logger.error(traceback.format_exc())
        raise HTTPException(status_code=500, detail=str(e))

3. é€’å½’ Copy ç›®å½•çš„æ ¸å¿ƒé€»è¾‘

def copy_folder(copy_request: CopyRequest):
    if copy_request.source_type == "s3":
        paginator = s3_client.get_paginator('list_objects_v2')
        for page in paginator.paginate(Bucket=copy_request.source_bucket, Prefix=copy_request.source_object):
            for obj in page.get('Contents', []):
                key = obj['Key']
                # å–å‡ºç›®æ ‡æ–‡ä»¶è·¯å¾„
                relative_path = key[len(copy_request.source_object):]
                destination_key = copy_request.destination_object + relative_path

                # ä¸‹è½½ -> ä¸Šä¼ 
                s3_object = s3_client.get_object(Bucket=copy_request.source_bucket, Key=key)
                data = s3_object['Body'].read()
                minio_client.put_object(copy_request.destination_bucket, destination_key, data, len(data))
                logger.info(f"Copied {key} to {destination_key}")

    elif copy_request.source_type == "minio":
        objects = minio_client.list_objects(copy_request.source_bucket, prefix=copy_request.source_object, recursive=True)
        for obj in objects:
            key = obj.object_name
            relative_path = key[len(copy_request.source_object):]
            destination_key = copy_request.destination_object + relative_path

            response = minio_client.get_object(copy_request.source_bucket, key)
            data = response.read()
            s3_client.put_object(Bucket=copy_request.destination_bucket, Key=destination_key, Body=data)
            logger.info(f"Copied {key} to {destination_key}")

    else:
        raise ValueError("Unsupported source type")

âœ… æœ€åï¼Œç¤ºä¾‹è¯·æ±‚

å•ä¸ªæ–‡ä»¶ copy

POST /copy
{
    "source_type": "s3",
    "source_bucket": "my-source-bucket",
    "source_object": "myfolder/file1.txt",
    "destination_type": "minio",
    "destination_bucket": "my-dest-bucket",
    "destination_object": "backup/file1.txt"
}

æ–‡ä»¶å¤¹é€’å½’ copy

POST /copy?copy_type=folder
{
    "source_type": "s3",
    "source_bucket": "my-source-bucket",
    "source_object": "myfolder/",
    "destination_type": "minio",
    "destination_bucket": "my-dest-bucket",
    "destination_object": "backup/"
}

æŸ¥çœ‹ bucket å’Œç›®å½•å†…å®¹

GET /list?storage_type=s3

GET /list?storage_type=minio&bucket=mybucket&prefix=myfolder/

ğŸ”¥ æ€»ç»“ä½ çš„éœ€æ±‚çŠ¶æ€

åŠŸèƒ½	æ–¹æ¡ˆ	æ˜¯å¦å®Œæˆ
Swagger Example	Field + example	âœ…
åˆ—å‡º Bucket & ç›®å½•	/list æ¥å£	âœ…
å•ä¸ªæ–‡ä»¶ copy	æ”¯æŒ	âœ…
æ•´ä¸ªç›®å½•é€’å½’ copy	è‡ªå·±å†™é€’å½’	âœ…
æ”¯æŒ Swagger UI	FastAPI è‡ªå¸¦	âœ…

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä»½å®Œæ•´çš„æ•´åˆç‰ˆé¡¹ç›®ä»£ç ï¼Œæ‰“åŒ…ç»™ä½ ã€‚
è¦æˆ‘å¸®ä½ æ•´ç†å—ï¼Ÿ
