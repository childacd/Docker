å¾ˆå¥½ï¼ğŸ¯ä½ ç°åœ¨æ‰“ç®—ï¼š

	âœ… æ”¾å¼ƒå¯†ç ç™»å½•ï¼Œæ”¹ä¸ºé€šè¿‡ SSH Key ç™»å½•å®¹å™¨ï¼Œå¹¶å°†å®¹å™¨å†…çš„ $HOME ç›®å½•ï¼ˆå¦‚ /home/youruserï¼‰æŒ‚è½½åˆ°å®¿ä¸»æœºå¯¹åº”ç›®å½•ä¸Šï¼ˆå¦‚ /home/youruserï¼‰

è¿™æ˜¯éå¸¸å¯é ã€ç¬¦åˆ DevOps æœ€ä½³å®è·µçš„æ–¹æ³•ã€‚

âœ… æœ€å°å¯è¡Œçš„ SSH Key ç™»å½•æ­¥éª¤ï¼ˆæ¦‚è§ˆï¼‰
	1.	âœ… å®¿ä¸»æœºä¸Šå·²æœ‰ä½ çš„ ~/.ssh/id_rsa.pub å…¬é’¥
	2.	âœ… å°†å®¹å™¨ä¸­ç”¨æˆ·çš„ ~/.ssh/authorized_keys å†™å…¥è¯¥å…¬é’¥
	3.	âœ… è®¾ç½®æ­£ç¡®æƒé™ï¼ˆéå¸¸å…³é”®ï¼‰
	4.	âœ… å®¹å™¨ sshd_config ä¸­å¯ç”¨äº†å…¬é’¥è®¤è¯
	5.	âœ… ä½¿ç”¨ ssh -i ç™»å½•æµ‹è¯•

âœ… è¯¦ç»†æ“ä½œæ­¥éª¤

ğŸ§± å‡è®¾ä¿¡æ¯
	â€¢	ç”¨æˆ·åï¼šyouruser
	â€¢	å®¿ä¸»æœºå®¶ç›®å½•ï¼š/home/youruser
	â€¢	å®¿ä¸»æœºå…¬é’¥ï¼š/home/youruser/.ssh/id_rsa.pub
	â€¢	å®¹å™¨æŒ‚è½½è·¯å¾„ï¼š/home/youruserï¼ˆä¹Ÿå°±æ˜¯å®¹å™¨å†…çš„ $HOMEï¼‰

âœ… Step 1ï¼šæ„å»ºå®¹å™¨æ”¯æŒ SSH Key ç™»å½•ï¼ˆé…ç½® sshdï¼‰

åœ¨ Dockerfile é‡Œæ·»åŠ ï¼š

# å…è®¸å…¬é’¥ç™»å½•
RUN sed -i 's/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config && \
    sed -i 's/^#\?AuthorizedKeysFile.*/AuthorizedKeysFile .ssh\/authorized_keys/' /etc/ssh/sshd_config

è¿™ä¸‰è¡Œè®¾ç½®ï¼š
	â€¢	âœ… å¼€å¯å…¬é’¥è®¤è¯
	â€¢	âœ… ç¦ç”¨å¯†ç è®¤è¯ï¼ˆæ›´å®‰å…¨ï¼‰
	â€¢	âœ… ç¡®ä¿é»˜è®¤è¯»å–çš„æ˜¯ ~/.ssh/authorized_keys

âœ… Step 2ï¼šè¿è¡Œå®¹å™¨æ—¶æŒ‚è½½å®¿ä¸»æœº home åˆ°å®¹å™¨ä¸­

å‡è®¾ä½ å®¿ä¸»æœºç”¨æˆ·æ˜¯ youruserï¼š

docker run -d \
  -p 2222:22 \
  -v /home/youruser:/home/youruser \
  --name ssh-container \
  your-ssh-image

è¿™ä¼šæŠŠå®¿ä¸»æœºçš„ /home/youruser ç›´æ¥ä½œä¸ºå®¹å™¨é‡Œ youruser ç”¨æˆ·çš„ $HOME ç›®å½•ã€‚

âœ… Step 3ï¼šåœ¨å®¿ä¸»æœºè®¾ç½® SSH å…¬é’¥ï¼ˆå¦‚æœè¿˜æ²¡è®¾ç½®ï¼‰

å¦‚æœä½ è¿˜æ²¡æœ‰ keyï¼Œå¯ä»¥å…ˆç”Ÿæˆä¸€å¯¹ï¼š

ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa

ç„¶åæŠŠå…¬é’¥æ”¾åˆ°ï¼š

mkdir -p ~/.ssh
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

ï¼ˆè®°ä½è¿™äº›æ˜¯åœ¨å®¿ä¸»æœº /home/youruser ä¸‹è®¾ç½®ï¼Œå®¹å™¨å†…ä¹Ÿä¼šçœ‹åˆ°ï¼‰

âœ… Step 4ï¼šç¡®è®¤å®¹å™¨ç”¨æˆ· UID/GID å’Œå®¿ä¸»æœºä¸€è‡´

å¦‚æœä½ å®¿ä¸»æœºçš„ youruser æ˜¯ UID 1000ã€GID 1000ï¼Œé‚£ä¹ˆå®¹å™¨ä¸­åˆ›å»ºç”¨æˆ·æ—¶åº”åŒ¹é…ï¼š

RUN groupadd -g 1000 youruser && \
    useradd -m -u 1000 -g 1000 -s /bin/bash youruser

å¦åˆ™ä½ ä¼šé‡åˆ°æƒé™é”™è¯¯æˆ– .ssh/authorized_keys æ— æ³•è¯»å–çš„é—®é¢˜ã€‚

âœ… Step 5ï¼šç™»å½•éªŒè¯

ssh -i ~/.ssh/id_rsa youruser@localhost -p 2222

å¦‚æœä¸€åˆ‡é…ç½®æ­£ç¡®ï¼Œä½ åº”è¯¥ç›´æ¥ç™»å½•æˆåŠŸï¼Œæ— éœ€è¾“å…¥å¯†ç ã€‚

âœ… SSH Key ç™»å½•å¸¸è§å‘ & éªŒè¯æ–¹æ³•

é¡¹ç›®	è¦æ±‚
~/.ssh ç›®å½•æƒé™	chmod 700 ~/.ssh
authorized_keys æ–‡ä»¶æƒé™	chmod 600 ~/.ssh/authorized_keys
æ–‡ä»¶ owner	å¿…é¡»æ˜¯ youruserï¼Œä¸è¦è¢« root å ç”¨
å®¹å™¨ä¸­ sshd_config é…ç½®æ­£ç¡®	PubkeyAuthentication yesï¼Œè·¯å¾„ä¸º .ssh/authorized_keys
æ—¥å¿—æŸ¥çœ‹ï¼ˆå®¹å™¨å†…ï¼‰	tail -f /var/log/auth.log æˆ– journalctl -u ssh

âœ… é™„åŠ å»ºè®®ï¼šå¦‚æœä½ å®¹å™¨æ˜¯ Alpine é•œåƒæˆ–æ—  PAMï¼Œä½¿ç”¨ dropbear æ›´è½»é‡ï¼›å¦åˆ™ Ubuntu + openssh-server æœ€é è°±ã€‚

éœ€è¦æˆ‘ä¸ºä½ å†™ä¸€å¥— Dockerfile + run è„šæœ¬ï¼Œå®Œæ•´å®ç°â€œå®¿ä¸»æœºæŒ‚è½½ home + SSH Key ç™»å½•å®¹å™¨â€çš„å®Œæ•´ demo å—ï¼Ÿä½ å°±å¯ä»¥ç›´æ¥å¤åˆ¶ç²˜è´´ç”¨äº†ã€‚
