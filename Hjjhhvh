ä½ çš„ä»£ç é€»è¾‘å·²ç»å†™å¾—å¾ˆæ¸…æ™°äº†ï¼ğŸ‘ èƒ½æ­£ç¡®åœ°åŒºåˆ†æ˜¯å¦æ˜¯ object not foundï¼Œå†å†³å®šæ˜¯å¦ retryï¼Œæ•´ä¸ª retry loop ä¹Ÿå†™å¾—å¾ˆè§„èŒƒã€‚

ä¸è¿‡æˆ‘ä»¬å¯ä»¥ è¿›ä¸€æ­¥åšä¸€äº›å°ä¼˜åŒ–ï¼Œæé«˜ä»£ç çš„å¯è¯»æ€§ã€å¯ç»´æŠ¤æ€§ å’Œ å¥å£®æ€§ï¼š

âœ… ä¼˜åŒ–å»ºè®®ï¼ˆé€æ¡ï¼‰

1ï¸âƒ£ in result.stderr å»ºè®®ç»Ÿä¸€å¤§å°å†™åˆ¤æ–­ï¼Œé¿å…é—æ¼

å½“å‰ï¼š

elif "Unable to stat-source" in result.stderr and "Object does not exist" in result.stderr:

å¦‚æœ stderr å†…å®¹æ˜¯å¤§å°å†™ä¸åŒçš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚ "object DOES NOT exist"ï¼Œå°±ä¼šæ¼åˆ¤ã€‚

æ¨èæ”¹æˆï¼š

stderr = result.stderr.lower()
if "unable to stat-source" in stderr and "object does not exist" in stderr:
    return False

ä¹Ÿå¯ä»¥å†™ä¸ªå·¥å…·å‡½æ•°ï¼š

def is_source_missing(stderr: str) -> bool:
    msg = stderr.lower()
    return "unable to stat-source" in msg and "object does not exist" in msg

ç„¶åè¿™æ ·è°ƒç”¨ï¼š

if is_source_missing(result.stderr):
    return False

2ï¸âƒ£ retry loop å¯æŠ½æˆç‹¬ç«‹å‡½æ•°ï¼ˆæ›´æ¸…æ™°å¤ç”¨ï¼‰

æ¯”å¦‚æŠŠ retry æŠ½æˆä¸€ä¸ªå°å‡½æ•°ï¼š

def retry_run(self, job_id, job_name, command, retries=2, delay=1) -> bool:
    for attempt in range(1, retries + 1):
        time.sleep(delay)
        logging.info(f'Retry attempt {attempt} for job {job_name} (job_id: {job_id})')
        result: JobResult = self.run_process(job_id, job_name, command)
        if result.success:
            return True
    logging.info(f"All attempts failed for job {job_name} (job_id: {job_id})")
    return False

ç„¶åä½ çš„ job_func() ä¼šæ›´æ¸…çˆ½ï¼š

def job_func():
    result: JobResult = self.run_process(job_id, job_name, command)
    if result.success:
        return True

    if is_source_missing(result.stderr):
        return False

    return self.retry_run(job_id, job_name, command)

3ï¸âƒ£ æ—¥å¿—å»ºè®®ä½¿ç”¨ logger è€Œä¸æ˜¯ logging ç›´æ¥è°ƒç”¨ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ å·²ç»åœ¨ç±»é‡Œå®šä¹‰äº†ï¼š

self.logger = logging.getLogger(__name__)

é‚£ä¹ˆç”¨ï¼š

self.logger.info(...)

ä¼šæ›´æ¸…æ™°ï¼Œå¹¶ç»§æ‰¿ä½ é¡¹ç›®çš„ logging é…ç½®ã€‚

âœ… æ€»ç»“ä¼˜åŒ–åç»“æ„

ä½ çš„æ€è·¯æ˜¯å®Œå…¨æ­£ç¡®çš„ï¼Œä»¥ä¸‹æ˜¯æˆ‘æ¨èçš„ç»“æ„ï¼š

def is_source_missing(stderr: str) -> bool:
    msg = stderr.lower()
    return "unable to stat-source" in msg and "object does not exist" in msg

def retry_run(self, job_id, job_name, command, retries=2, delay=1) -> bool:
    for attempt in range(1, retries + 1):
        time.sleep(delay)
        self.logger.info(f'Retry attempt {attempt} for job {job_name} (job_id: {job_id})')
        result: JobResult = self.run_process(job_id, job_name, command)
        if result.success:
            return True
    self.logger.info(f"All attempts failed for job {job_name} (job_id: {job_id})")
    return False

def job_func():
    result: JobResult = self.run_process(job_id, job_name, command)
    if result.success:
        return True
    if is_source_missing(result.stderr):
        return False
    return self.retry_run(job_id, job_name, command)

å¦‚æœä½ è§‰å¾—è¿™ä¸ªç»“æ„ä¸é”™ï¼Œæˆ‘ä¹Ÿå¯ä»¥å¸®ä½ ä¸€èµ·è¡¥ä¸Šæ³¨é‡Šã€å•æµ‹ mock æˆ– retry æ—¥å¿—ç»“æ„åŒ–è¾“å‡ºï¼ˆä¾‹å¦‚ JSON logï¼‰ã€‚ä½ å¯ä»¥å‘Šè¯‰æˆ‘ä½ æƒ³ç»§ç»­å®Œå–„å“ªä¸ªæ–¹å‘ ğŸ‘
