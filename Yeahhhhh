å¥½çš„ï¼Œæˆ‘ç›´æ¥æŠŠ â€œå·²å¤„ç†æ ‡è®° + è‡ªåŠ¨è·³è¿‡â€ å®Œæ•´æ•´åˆåˆ°ä½ çš„è½®è¯¢è„šæœ¬é‡Œã€‚
ä½ åªè¦æŠŠä¸‹é¢è¿™æ®µä»£ç å¤åˆ¶åˆ°ä½ çš„è„šæœ¬é‡Œå³å¯ä½¿ç”¨ã€‚

ä»¥ä¸‹ä»£ç åŒ…å«ï¼š
	1.	æ£€æµ‹æ˜¯å¦å·²å¤„ç†ï¼ˆæ˜¯å¦åŒ…å« [AutoSQL] æ ‡è®°ï¼‰
	2.	å¦‚æœæœªå¤„ç† â†’ æå– JSON + ç”Ÿæˆ temp file + è°ƒ worker + æ·»åŠ  SQL åˆ° RITM æ³¨é‡Š
	3.	å¦‚æœå·²å¤„ç† â†’ è‡ªåŠ¨è·³è¿‡ï¼Œä¸é‡å¤æ‰§è¡Œ

æˆ‘ä¼šç”¨ä½ ç›®å‰çš„è„šæœ¬ç»“æ„ï¼ˆè½®è¯¢ + extract json + workerï¼‰æ•´åˆè¿›å»ã€‚

âœ… å®Œæ•´å¯ç›´æ¥å¤åˆ¶çš„ä¿®æ”¹ç‰ˆ poll è„šæœ¬ç‰‡æ®µï¼ˆå« AutoSQL å¹‚ç­‰é€»è¾‘ï¼‰

è¯·æŠŠä¸‹é¢å†…å®¹æ”¾è¿›ä½ çš„ poll_servicenow() çš„å¾ªç¯éƒ¨åˆ†é‡Œï¼š

for item in data:
    sys_id = item.get("sys_id")
    description = item.get("description") or ""
    comments = item.get("comments") or ""
    work_notes = item.get("work_notes") or ""

    # -------------------------------------------
    # 1. Skip tickets that were already processed
    # -------------------------------------------
    if "[AutoSQL]" in description or "[AutoSQL]" in comments or "[AutoSQL]" in work_notes:
        print(f"[Skip] RITM {item.get('number')} already processed.")
        continue

    print("-------------------------------------------------")
    print(f"RITM Number: {item.get('number')}")
    print(f"Short Description: {item.get('short_description')}")
    print(f"Created On: {item.get('sys_created_on')}")
    print(f"Updated On: {item.get('sys_updated_on')}")
    print(f"State: {item.get('state')}")

    # -------------------------------------------
    # 2. Extract JSON from description
    # -------------------------------------------
    json_section = extract_json_section(description)
    json_list = extract_json_objects(json_section)

    print("Parsed JSON requests:", json_list)

    if not json_list:
        print("[Warn] No JSON extracted. Skipped.")
        continue

    # -------------------------------------------
    # 3. Write JSON to temp file
    # -------------------------------------------
    temp_file = write_temp_json_file(json_list)

    # -------------------------------------------
    # 4. Call worker script
    # -------------------------------------------
    # Replace dummy args as needed
    # (Or replace subprocess with direct import)
    run_worker_script(temp_file)

    # -------------------------------------------
    # 5. Add SQL or processing results as comment
    # -------------------------------------------
    sql_generated = "/* dummy SQL output example */\nSELECT * FROM my_table;"  # Replace with real output

    comment_text = f"""[AutoSQL] Automatically processed.

Generated SQL:

{sql_generated}

-- End of Auto-generated SQL --
"""

    add_comment_to_ritm(
        sys_id=sys_id,
        sql_text=comment_text,
        instance=INSTANCE,
        username=USERNAME,
        password=PASSWORD
    )

    print(f"[Done] Processed and commented RITM {item.get('number')}")
    print("-------------------------------------------------")

    # Collect updated time to move last_check_time cursor
    new_times.append(item["sys_updated_on"])

âœ… add_comment_to_ritm() å‡½æ•°ï¼ˆå¸¦æ¢è¡Œ + AutoSQL tagï¼‰

è¯·æ”¾åœ¨è„šæœ¬é¡¶éƒ¨æˆ– utils é‡Œï¼š

def add_comment_to_ritm(sys_id, sql_text, instance, username, password):
    url = f"https://{instance}/api/now/table/sc_req_item/{sys_id}"

    payload = {
        "work_notes": sql_text
    }

    response = requests.patch(
        url,
        auth=(username, password),
        json=payload,
        headers={"Content-Type": "application/json"},
        verify=False
    )

    if response.status_code not in (200, 201):
        print("[âŒ Failed to add comment]", response.status_code, response.text)
    else:
        print("[âœ… Comment added to RITM]", sys_id)

ğŸ‰ ç°åœ¨ä½ çš„è‡ªåŠ¨åŒ–ç³»ç»Ÿæ­£å¼å…·å¤‡å¹‚ç­‰èƒ½åŠ›

æ•ˆæœï¼š
	â€¢	æ¯ 10 ç§’è½®è¯¢
	â€¢	å‘ç°æ–° RITM â†’ è‡ªåŠ¨å¤„ç†
	â€¢	å¤„ç†å®Œæˆ â†’ åœ¨ Comments åŠ ä¸Š [AutoSQL]
	â€¢	ä¸‹æ¬¡è½®è¯¢çœ‹åˆ° [AutoSQL] â†’ è‡ªåŠ¨è·³è¿‡ â†’ æ°¸è¿œä¸é‡å¤

ğŸ‘ ä½ è¿˜å¯ä»¥å‡çº§çš„ç‚¹ï¼ˆéšæ—¶å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¸®ä½ ç»§ç»­æ‰©å±•ï¼‰
	â€¢	æŠŠ SQL è¾“å‡ºæ”¹æˆçœŸå® worker çš„æ‰§è¡Œç»“æœ
	â€¢	è‡ªåŠ¨æŠŠ SQL ä½œä¸ºé™„ä»¶ä¸Šä¼ åˆ° RITM
	â€¢	è‡ªåŠ¨æ›´æ–° RITM state=2ï¼ˆWork in Progressï¼‰
	â€¢	è‡ªåŠ¨æŠŠå¤„ç†ç»“æœå†™å…¥ work_notes
	â€¢	è‡ªåŠ¨æŠŠé”™è¯¯å†™å› RITM
	â€¢	æŠŠæ•´ä¸ªå¤„ç†å˜æˆ systemd æœåŠ¡
	â€¢	åšæˆ Docker å®¹å™¨åå°è¿è¡Œ
	â€¢	åŠ å¹¶å‘é˜Ÿåˆ—å¤„ç†å¤šä¸ª RITM

ä½ æ¥ä¸‹æ¥æƒ³æ‰©å±•å“ªä¸€ä¸ªï¼Ÿ
