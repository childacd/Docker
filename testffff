ä½ è¿™ä¸ªæƒ³æ³•æ•´ä½“æ–¹å‘æ˜¯å¯¹çš„ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªå¾ˆâ€œå·¥ç¨‹åŒ–â€çš„è®¾è®¡ğŸ‘
æˆ‘åˆ†ä¸‰æ­¥æ¥å›ç­”ä½ ï¼š

1ï¸âƒ£ å…ˆç¡®è®¤ä½ çš„ç†è§£å¯¹ä¸å¯¹ï¼ˆçº¿ç¨‹ / æ—¥å¿— / scheduleï¼‰
2ï¸âƒ£ æŠŠä½ ç°åœ¨è¿™ä¸ªç³»ç»ŸæŠ½è±¡æˆä¸€ä¸ªâ€œé€šç”¨æ¶æ„â€
3ï¸âƒ£ ç»™ä½ ä¸€ä¸ªã€Œæœ€å°å¯è·‘ã€çš„ Python ç¤ºä¾‹ä»£ç ï¼ˆåŒ…å« YAML + scheduler + handler æ’ä»¶åŒ–ï¼‰

ä¸€ã€å…ˆå›ç­”ä½ ç¬¬ä¸€ä¸ªé—®é¢˜ï¼šç”¨ä¸€ä¸ªçº¿ç¨‹ + schedule å¯¹ä¸å¯¹ï¼Ÿ

âœ… ä½ çš„åˆ¤æ–­åŸºæœ¬æ˜¯æ­£ç¡®çš„

ä½ ç°åœ¨æ‹…å¿ƒçš„ç‚¹ä¸»è¦æœ‰ä¸¤ä¸ªï¼š

â‘  å¤šä¸ª flow å„å¼€çº¿ç¨‹ â†’ æ—¥å¿—ä¼šä¸ä¼šæ··ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š
ğŸ‘‰ â€œä¼šæ··ï¼Œä½†å¯æ§â€
	â€¢	Python logging æ˜¯ thread-safe çš„
	â€¢	ä½†å¦‚æœï¼š
	â€¢	å¤šçº¿ç¨‹åŒæ—¶è·‘
	â€¢	éƒ½å¾€åŒä¸€ä¸ª stdout / æ–‡ä»¶æ‰“ log
	â€¢	é‚£é˜…è¯»ä½“éªŒä¼šå¾ˆå·®ï¼Œå°¤å…¶æ˜¯æ’æŸ¥é—®é¢˜æ—¶

ä½ å½“ç„¶å¯ä»¥é ï¼š
	â€¢	threadName
	â€¢	request_id
	â€¢	flow_name
æ¥åŒºåˆ†
ä½†å¤æ‚åº¦ä¼šä¸Šå‡

â‘¡ ç”¨ä¸€ä¸ªä¸»çº¿ç¨‹ + scheduleï¼Œè®© flow ä¸²è¡Œæ‰§è¡Œï¼Ÿ

âœ… è¿™æ˜¯ä¸€ä¸ªå¾ˆåˆç†çš„ PoC / ç¬¬ä¸€ç‰ˆè®¾è®¡

schedule çš„è¡Œä¸ºæ˜¯ï¼š
	â€¢	å•çº¿ç¨‹
	â€¢	job åˆ°æ—¶é—´äº† â†’ ä¾æ¬¡æ‰§è¡Œ
	â€¢	å¦‚æœä¸¤ä¸ª job æ°å¥½åŒä¸€æ—¶åˆ»è§¦å‘ï¼š
	â€¢	ä¼šé¡ºåºæ‰§è¡Œ
	â€¢	åä¸€ä¸ªç­‰å‰ä¸€ä¸ªå®Œæˆ

âœ… è¿™æ­£å¥½æ»¡è¶³ä½ è¯´çš„ï¼š

	å“ªæ€• start æ—¶é—´æ’åœ¨ä¸€èµ·ï¼Œä¹Ÿä¼šå…ˆåæ‰§è¡Œï¼Œæ—¥å¿—ä¸ä¼šæ··

âš ï¸ å”¯ä¸€è¦æ³¨æ„çš„ä¸€ç‚¹ï¼ˆå…ˆçŸ¥é“å°±è¡Œï¼‰ï¼š
	â€¢	å¦‚æœæŸä¸ª handler è·‘å¾ˆä¹…
	â€¢	åé¢çš„ flow ä¼šè¢«é˜»å¡
ä½†ä½ ç°åœ¨è¿™ä¸ªé˜¶æ®µå®Œå…¨ OK

âœ… æ‰€ä»¥ç»“è®ºä¸€å¥è¯ï¼š

	ç”¨ä¸€ä¸ªä¸»çº¿ç¨‹ + schedule åšè½®è¯¢ï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¹²å‡€ã€å¯ç»´æŠ¤ã€å¥½ debug çš„ç¬¬ä¸€ç‰ˆæ–¹æ¡ˆ

äºŒã€ä½ çœŸæ­£æƒ³åšçš„ï¼Œå…¶å®æ˜¯ä¸€ä¸ªã€Œæ’ä»¶åŒ– Flow Engineã€

æŠŠä½ çš„è¯æŠ½è±¡ä¸€ä¸‹ï¼Œä½ çœŸæ­£æƒ³è¦çš„æ˜¯ï¼š

	é…ç½®é©±åŠ¨ + handler è§£è€¦ + å¯æ‰©å±•

å¯ä»¥æŠ½æˆ 4 å±‚ï¼š

YAML Config
   â†“
Flow Definitionï¼ˆé…ç½®å¯¹è±¡ï¼‰
   â†“
Listenerï¼ˆServiceNow API æŸ¥è¯¢ï¼‰
   â†“
Handlerï¼ˆå…·ä½“ä¸šåŠ¡é€»è¾‘ï¼‰

æ¯ä¸ª flow æœ¬è´¨å°±æ˜¯ï¼š

Every N minutes:
  ç”¨ filter å» ServiceNow æŸ¥ RITM
  å¦‚æœæœ‰æ–°æ•°æ®:
    äº¤ç»™æŒ‡å®š handler å»å¤„ç†

âœ… æ–°å¢ flow =
	â€¢	åŠ ä¸€æ®µ YAML
	â€¢	æ–°å¢ä¸€ä¸ª handler ç±»
	â€¢	ä¸æ”¹ä¸»æµç¨‹ä»£ç 

è¿™ç‚¹ä½ æƒ³å¾—éå¸¸å¯¹

ä¸‰ã€æœ€å°å¯è¿è¡Œç¤ºä¾‹ï¼ˆè´´è¿‘ä½ ç°åœ¨çš„è®¾è®¡ï¼‰

ä¸‹é¢è¿™å¥—ä»£ç æ˜¯ï¼š

âœ… å•çº¿ç¨‹
âœ… schedule ä¸²è¡Œ
âœ… YAML é©±åŠ¨
âœ… handler æ’ä»¶åŒ–
âœ… æ—¥å¿—ä¸ä¼šæ··

1ï¸âƒ£ flow_config.yamlï¼ˆç®€åŒ–ç‰ˆï¼‰

flows:
  - name: Copy_minio_request_flow
    enable: true
    interval: 5
    listen_on:
      type: RITM
      status: Open
      filter: "catalog_item=minio_copy"
    handler: CopyMinioRequestHandler

  - name: Create_Bucket_flow
    enable: true
    interval: 30
    listen_on:
      type: RITM
      status: InProgress
      filter: "catalog_item=create_bucket"
    handler: CreateBucketHandler

2ï¸âƒ£ handlers.pyï¼ˆæ’ä»¶å¼ Handlerï¼‰

class BaseHandler:
    def handle(self, records: list[dict]):
        raise NotImplementedError


class CopyMinioRequestHandler(BaseHandler):
    def handle(self, records):
        for r in records:
            print(f"[CopyMinio] handling RITM {r['id']}")


class CreateBucketHandler(BaseHandler):
    def handle(self, records):
        for r in records:
            print(f"[CreateBucket] handling RITM {r['id']}")

3ï¸âƒ£ servicenow_client.pyï¼ˆæ¨¡æ‹Ÿ ServiceNow APIï¼‰

import random

class ServiceNowClient:

    def query_ritm(self, *, status: str, filter: str) -> list[dict]:
        # è¿™é‡Œå…ˆ mockï¼ŒçœŸå®æƒ…å†µä¸‹æ¢æˆ API è°ƒç”¨
        if random.choice([True, False]):
            return [
                {"id": f"RITM{random.randint(1000,9999)}", "status": status}
            ]
        return []

4ï¸âƒ£ flow_engine.pyï¼ˆæ ¸å¿ƒè°ƒåº¦é€»è¾‘ï¼‰

import schedule
import time
import yaml
import logging

from servicenow_client import ServiceNowClient
from handlers import (
    CopyMinioRequestHandler,
    CreateBucketHandler,
)

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s"
)

HANDLER_REGISTRY = {
    "CopyMinioRequestHandler": CopyMinioRequestHandler,
    "CreateBucketHandler": CreateBucketHandler,
}


class FlowEngine:

    def __init__(self, config_path: str):
        with open(config_path) as f:
            self.config = yaml.safe_load(f)

        self.sn_client = ServiceNowClient()

    def start(self):
        for flow in self.config["flows"]:
            if not flow.get("enable", False):
                continue

            interval = flow["interval"]
            schedule.every(interval).minutes.do(self.run_flow, flow)

        logging.info("Flow engine started")

        while True:
            schedule.run_pending()
            time.sleep(1)

    def run_flow(self, flow: dict):
        flow_name = flow["name"]
        logging.info(f"[{flow_name}] polling started")

        listen_on = flow["listen_on"]
        records = self.sn_client.query_ritm(
            status=listen_on["status"],
            filter=listen_on["filter"]
        )

        if not records:
            logging.info(f"[{flow_name}] no new records")
            return

        handler_cls = HANDLER_REGISTRY[flow["handler"]]
        handler = handler_cls()

        logging.info(f"[{flow_name}] {len(records)} record(s) found")
        handler.handle(records)

5ï¸âƒ£ main.pyï¼ˆå¯åŠ¨ï¼‰

from flow_engine import FlowEngine

engine = FlowEngine("flow_config.yaml")
engine.start()

å››ã€ä¸ºä»€ä¹ˆè¿™ä¸ªè®¾è®¡åé¢å¾ˆå¥½è¿›åŒ–ï¼Ÿ

ä½ ä¹‹åéå¸¸è‡ªç„¶å°±èƒ½åŠ ï¼š
	â€¢	âœ… flow çº§åˆ« loggerï¼ˆLoggerAdapterï¼‰
	â€¢	âœ… handler è¶…æ—¶ä¿æŠ¤
	â€¢	âœ… handler å¹‚ç­‰æ€§
	â€¢	âœ… å¹¶è¡Œ/ä¸²è¡Œå¯é…ç½®ï¼ˆper flowï¼‰
	â€¢	âœ… åŠ¨æ€ reload YAML
	â€¢	âœ… request_id / ritm_id è´¯ç©¿æ—¥å¿—

äº”ã€ä¸€å¥æ€»ç»“ä½ ç°åœ¨è¿™ä¸ªè®¾è®¡æ€è·¯

	âœ… ä½ ç°åœ¨çš„æ€è·¯ä¸æ˜¯â€œå‡‘ä»£ç â€
âœ… è€Œæ˜¯åœ¨åšä¸€ä¸ªå°å‹äº‹ä»¶é©±åŠ¨ / flow engine
âœ… ç”¨ schedule + YAML + handler registry
å®Œå…¨åˆç†ï¼Œè€Œä¸”éå¸¸é€‚åˆ PoC â†’ Production çš„æ¼”è¿›è·¯å¾„

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ ï¼š
	â€¢	æŠŠè¿™ä¸ªæ”¹æˆ async ç‰ˆæœ¬
	â€¢	æˆ–è€…åŠ  flow çº§åˆ« logger ä¸æ··æ—¥å¿—
	â€¢	æˆ–è€… æ”¯æŒä¸€ä¸ª RITM è¢«å¤šä¸ª flow å¤„ç†ï¼ˆfan-outï¼‰

ä½ æƒ³ä¸‹ä¸€æ­¥å¾€å“ªæ¼”è¿›ï¼Ÿ
