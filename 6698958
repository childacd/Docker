å¥½çš„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´å¯è¿è¡Œçš„ç¤ºä¾‹é¡¹ç›®ï¼Œå®ƒæ»¡è¶³ä½ çš„è¦æ±‚ï¼š

	âœ… å®¹å™¨å…¥å£æ˜¯ /usr/sbin/sshd -D
âœ… å®¹å™¨ç”¨ root å¯åŠ¨ï¼Œå…ˆè¿è¡Œ sshd
âœ… ç„¶åè‡ªåŠ¨åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·ï¼ˆå¦‚ youruserï¼‰æ‰§è¡Œä¸»å‘½ä»¤æˆ–è¿›å…¥ shell

âœ… é¡¹ç›®ç»“æ„ä¸€è§ˆ

your-project/
â”œâ”€â”€ Dockerfile
â””â”€â”€ entrypoint.sh

ğŸ³ Dockerfile

FROM ubuntu:20.04

# å®‰è£… ssh æœåŠ¡å’Œ su å·¥å…·
RUN apt-get update && \
    apt-get install -y openssh-server sudo && \
    mkdir -p /var/run/sshd

# åˆ›å»ºé root ç”¨æˆ·
RUN useradd -m -s /bin/bash youruser && \
    echo 'youruser:yourpassword' | chpasswd && \
    echo 'youruser ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# é…ç½® sshd å…è®¸å¯†ç ç™»å½• & å…¬é’¥ç™»å½•ï¼ˆéƒ½æ‰“å¼€ï¼Œæ–¹ä¾¿åˆ‡æ¢ï¼‰
RUN sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config && \
    sed -i 's/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config && \
    ssh-keygen -A

# å¼€æ”¾ SSH ç«¯å£
EXPOSE 22

# æ‹·è´å…¥å£è„šæœ¬
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# è®¾ç½®å…¥å£ä¸ºè„šæœ¬ï¼ˆé»˜è®¤ä»¥ root è¿è¡Œï¼‰
ENTRYPOINT ["/entrypoint.sh"]

ğŸ”§ entrypoint.sh

#!/bin/bash

# å¯åŠ¨ sshdï¼ˆå¿…é¡»ç”± root æ‰§è¡Œï¼‰
/usr/sbin/sshd

# å¦‚æœæœ‰ä¼ å…¥å‚æ•°ï¼Œåˆ™åˆ‡æ¢åˆ°æ™®é€šç”¨æˆ·å¹¶æ‰§è¡Œè¯¥å‘½ä»¤
if [ $# -eq 0 ]; then
    # æ²¡æœ‰å‚æ•°å°±è¿›å…¥ç”¨æˆ·çš„ shell
    exec su - youruser
else
    # æœ‰å‘½ä»¤å°±æ‰§è¡Œå®ƒ
    exec su - youruser -c "$*"
fi

âœ… æ„å»ºé•œåƒ

docker build -t ssh-user-demo .

âœ… è¿è¡Œå®¹å™¨ï¼ˆä¸åŠ  -uï¼‰

docker run -d --name my-ssh-container -p 2222:22 ssh-user-demo

âœ… æµ‹è¯• SSH ç™»å½•

ssh youruser@localhost -p 2222
# å¯†ç æ˜¯ yourpassword

âœ… æµ‹è¯•æŒ‚è½½ä¸»æœºç›®å½•

ä½ è¿˜å¯ä»¥åŠ ï¼š

docker run -d \
  -v /home/youruser:/home/youruser \
  -p 2222:22 \
  ssh-user-demo

âœ… å¯é€‰ï¼šä»¥åæ”¹ä¸ºåªæ”¯æŒ SSH key ç™»å½•

ä½ å¯ä»¥æ”¹ï¼š

RUN sed -i 's/^PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config

è¿™ä¸ªé¡¹ç›®å®Œæ•´å¯ç”¨ã€‚å¦‚æœä½ è¿˜éœ€è¦åŠ ä¸Š ~/.ssh/authorized_keys æŒ‚è½½å’Œæƒé™è®¾ç½®ï¼Œæˆ‘å¯ä»¥ç»§ç»­å¸®ä½ åŠ è¿›å»ã€‚éœ€è¦å—ï¼Ÿ
