å¾ˆå¥½ï¼Œä½ å·²ç»å¯ä»¥æˆåŠŸè¿æ¥å®¹å™¨çš„ SSH æœåŠ¡äº†ï¼Œä½†æ˜¯ï¼š

	ğŸ›‘ è¾“å®Œå¯†ç åæç¤º Permission denied

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¸¸è§çš„é—®é¢˜ï¼ŒåŸå› é›†ä¸­åœ¨å‡ ä¸ªåœ°æ–¹ï¼š

âœ… å¯èƒ½åŸå› ä¸€è§ˆ

åŸå› 	è§£é‡Š	å¦‚ä½•æ’æŸ¥
âŒ å¯†ç é”™è¯¯	çœ‹ä¼¼è¾“å¯¹äº†ï¼Œå…¶å®è¾“é”™äº†	ç¡®ä¿å¯†ç æ˜¯ä½ åœ¨ Dockerfile é‡Œè®¾ç½®çš„
âŒ root ç™»å½•è¢«ç¦ç”¨äº†	sshd_config ä¸­ PermitRootLogin no	æ£€æŸ¥é…ç½®æ–‡ä»¶
âŒ PasswordAuthentication è¢«ç¦ç”¨	ä¸èƒ½ç”¨å¯†ç ç™»å½•	æ£€æŸ¥é…ç½®æ–‡ä»¶
âŒ shell ä¸å­˜åœ¨æˆ–æƒé™ä¸è¶³	ç”¨æˆ·æ²¡æœ‰åˆæ³•çš„ shell	æŸ¥çœ‹ /etc/passwd
âŒ ç”¨æˆ· home ç›®å½•æƒé™é—®é¢˜	~/.ssh æˆ– ~ æƒé™ä¸å½“	æ£€æŸ¥æƒé™æ˜¯å¦ä¸ºè¯¥ç”¨æˆ·ã€æ¨¡å¼æ˜¯å¦ 700
âŒ å®¹å™¨ä¸­ PAM / NSS ä¸å®Œæ•´	æœ€å¸¸è§äº alpine ç³»	ä½¿ç”¨å®Œæ•´çš„ ubuntu/debian é•œåƒé¿å…é—®é¢˜

âœ… ä½ å¯ä»¥è¿™æ ·é€æ­¥æ’æŸ¥ï¼š

ğŸ” 1. ç¡®è®¤ sshd_config å…è®¸ root ç™»å½•å’Œå¯†ç è®¤è¯

å®¹å™¨å†…æ‰§è¡Œï¼š

cat /etc/ssh/sshd_config | grep -Ei 'PermitRootLogin|PasswordAuthentication'

ç»“æœåº”ä¸ºï¼š

PermitRootLogin yes
PasswordAuthentication yes

å¦‚æœä¸æ˜¯ï¼Œå°±ï¼š

sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

ç„¶åé‡å¯ sshdï¼š

service ssh restart
# æˆ–è€…
pkill sshd && /usr/sbin/sshd

ğŸ” 2. ç¡®è®¤ root å¯†ç æ­£ç¡®è®¾ç½®

å®¹å™¨å†…è¿è¡Œï¼š

grep root /etc/shadow

å¦‚æœä½ çœ‹åˆ° ! æˆ– *ï¼Œè¯´æ˜å¯†ç è¢«é”ä½äº†ã€‚

é‡æ–°è®¾ç½®å¯†ç ï¼š

echo "root:root" | chpasswd

å†è¯• SSH ç™»å½•ã€‚

ğŸ” 3. æ£€æŸ¥ /etc/passwd ä¸­ root çš„ shell æ˜¯åˆæ³•çš„

grep root /etc/passwd

ä½ åº”è¯¥çœ‹åˆ°ï¼š

root:x:0:0:root:/root:/bin/bash

å¦‚æœæœ€åæ˜¯ /usr/sbin/nologin æˆ– /bin/falseï¼Œä¹Ÿä¼šç™»å½•å¤±è´¥ã€‚ç”¨ä¸‹é¢å‘½ä»¤ä¿®å¤ï¼š

usermod -s /bin/bash root

ğŸ” 4. æ£€æŸ¥ home ç›®å½•å’Œæƒé™ï¼ˆå°¤å…¶æ˜¯è‡ªå»ºç”¨æˆ·ï¼‰

å¦‚æœä½ æ˜¯ç”¨ useradd æ·»åŠ çš„ç”¨æˆ·ï¼Œç¡®ä¿ï¼š

ls -ld /home/myuser
# åº”è¯¥æ˜¯ 700 å¹¶å½’å±è¯¥ç”¨æˆ·

å¦‚æœæƒé™æ˜¯ 755 æˆ–è€… owner é”™äº†ï¼Œä¹Ÿä¼šè§¦å‘ ssh æ‹’ç»ç™»å½•ã€‚

âœ… æœ€å°å¯ç”¨çš„ Dockerfile æ¨¡æ¿ï¼ˆå†æ ¸å¯¹ä¸€éï¼‰

FROM ubuntu:20.04

RUN apt-get update && apt-get install -y openssh-server && mkdir -p /var/run/sshd

RUN echo 'root:root' | chpasswd

RUN sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config && \
    sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

RUN ssh-keygen -A

EXPOSE 22
CMD ["/usr/sbin/sshd", "-D"]

è¿è¡Œå‘½ä»¤ï¼š

docker build -t ssh-enabled .
docker run -d -p 2222:22 ssh-enabled

ç„¶åè¿æ¥ï¼š

ssh root@localhost -p 2222
# å¯†ç æ˜¯ root

å¦‚æœä½ èƒ½è´´ä¸€ä¸‹ sshd_config é‡Œçš„å‡ è¡Œé…ç½®ï¼Œæˆ–è´´ä¸€ä¸‹ SSH æŠ¥é”™çš„å®Œæ•´æ—¥å¿—ï¼ˆåŠ ä¸Š -v å‚æ•°ï¼‰ï¼Œæˆ‘å¯ä»¥æ›´å‡†ç¡®åœ°åˆ¤æ–­é—®é¢˜æ‰€åœ¨ï¼š

ssh -v root@localhost -p 2222

æ˜¯å¦éœ€è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ª SSH ç™»å½•é—®é¢˜ä¸€é”®æ’æŸ¥è„šæœ¬ï¼Ÿ
