å¥½çš„ï¼è¿™ä¸ªéœ€æ±‚éå¸¸å…¸å‹ï¼š
â€œè½®è¯¢ ServiceNow RITM â†’ è‡ªåŠ¨æ·»åŠ è¯„è®º â†’ å·²å¤„ç†è¿‡çš„å°±è·³è¿‡â€ã€‚
æˆ‘ç»™ä½ ä¸€ä¸ª å®Œæ•´ã€å¯è¿è¡Œã€é²æ£’æ€§å¼ºçš„ Python è§£å†³æ–¹æ¡ˆï¼Œå¹¶å¸¦ä½ è§£é‡Šæ¯ä¸€æ­¥ã€‚

ğŸ§© ä½ çš„éœ€æ±‚æ‹†è§£ï¼š

âœ” æ¯ X åˆ†é’Ÿè½®è¯¢ä¸€æ¬¡ ServiceNow RITM è¡¨

âœ” æ ¹æ® filter æ‹¿åˆ°æœ€è¿‘ 1 å°æ—¶å†…æ–°åˆ›å»ºçš„ RITM

âœ” ç»™æ¯ä¸ª RITM æ·»åŠ ä¸€ä¸ªè‡ªåŠ¨ comment

âœ” ä¸‹æ¬¡è½®è¯¢æ—¶å¦‚æœå·²ç»æ·»åŠ è¿‡æˆ‘ä»¬çš„ comment â†’ å¿…é¡»è·³è¿‡

âœ” ä¸ä¼šé‡å¤å¤„ç†åŒä¸€ä¸ª RITMï¼ˆå¹‚ç­‰ï¼‰

ğŸŸ¦ è®¾è®¡æ€è·¯

ä¸ºäº†é¿å…é‡å¤å¤„ç†ï¼Œæˆ‘ä»¬æœ‰ 2 ç§æ–¹å¼ï¼š

ğŸ…° æ–¹æ³• Aï¼ˆæœ€ç¨³å¥ï¼Œæ¨èï¼‰ï¼š

åœ¨è®°å½•é‡Œæ‰“ä¸€ä¸ªâ€œå·²å¤„ç†æ ‡è®°ï¼ˆsys_tags æˆ–æŸä¸ªå­—æ®µï¼‰â€

å¦‚æœä½ æœ‰æƒé™åŠ å­—æ®µï¼Œå¯ä»¥åœ¨ RITM é‡ŒåŠ ï¼š

u_auto_sql_added = true

ä½†ä½ å¯èƒ½ä¸æƒ³æˆ–ä¸èƒ½æ”¹è¡¨ç»“æ„ã€‚

ğŸ…± æ–¹æ³• Bï¼ˆé€šç”¨ï¼Œä¸æ”¹è¡¨ç»“æ„ï¼‰ï¼š

æ£€æŸ¥ RITM çš„ comment æ˜¯å¦å·²ç»åŒ…å«æˆ‘ä»¬è‡ªåŠ¨åŠ çš„æ–‡æœ¬ â†’ å¦‚æœæœ‰ï¼Œå°±è·³è¿‡

ä¾‹å¦‚ä½ è‡ªåŠ¨åŠ çš„è¯„è®ºæ ¼å¼ï¼š

[Auto-SQL-Added]
<çœŸå® SQL å†…å®¹>

ä¸‹ä¸€æ¬¡åªè¦ comment é‡Œå­˜åœ¨ [Auto-SQL-Added]ï¼Œå°±ä¸å†å¤„ç†ã€‚

è¿™æ˜¯æœ€å¸¸ç”¨ã€æ— éœ€æ”¹è¡¨æœ€å®‰å…¨çš„æ–¹æ³•ã€‚

ğŸŸ© æˆ‘å°†é‡‡ç”¨ æ–¹æ³• Bï¼ˆæ£€æŸ¥ comment whether existsï¼‰

å®Œå…¨ä¸ç”¨æ”¹è¡¨ï¼Œä½ å¯ä»¥ç›´æ¥è¿è¡Œã€‚

ğŸš€ æœ€ç»ˆå®Œæ•´ Python ä»£ç ï¼ˆæ¨èä½¿ç”¨ï¼‰

import requests
import json
from datetime import datetime, timedelta


SN_INSTANCE = "https://xxxxx.service-now.com"
SN_USER = "xxx"
SN_PASS = "xxx"

HEADERS = {"Content-Type": "application/json"}


def get_recent_ritms(hours=1):
    """è·å–æœ€è¿‘ N å°æ—¶æ–°å»ºçš„ RITM"""
    now = datetime.utcnow()
    past_time = now - timedelta(hours=hours)

    # sys_created_on >= past_time
    query_time = past_time.strftime("%Y-%m-%d %H:%M:%S")

    url = f"{SN_INSTANCE}/api/now/table/sc_req_item"

    params = {
        "sysparm_query": f"sys_created_on>=javascript:gs.dateGenerate('{query_time}')",
        "sysparm_fields": "sys_id,number,sys_created_on",
        "sysparm_limit": "200"
    }

    resp = requests.get(url, auth=(SN_USER, SN_PASS), headers=HEADERS, params=params)
    resp.raise_for_status()
    return resp.json()["result"]


def ritm_has_auto_comment(ritm_sys_id):
    """æ£€æŸ¥æ­¤ RITM æ˜¯å¦å·²ç»æœ‰æˆ‘ä»¬è‡ªåŠ¨æ·»åŠ çš„è¯„è®º"""
    url = f"{SN_INSTANCE}/api/now/table/sc_req_item/{ritm_sys_id}?sysparm_fields=comments"

    resp = requests.get(url, auth=(SN_USER, SN_PASS), headers=HEADERS)
    resp.raise_for_status()

    comments = resp.json()["result"].get("comments", "")

    return "[Auto-SQL-Added]" in comments


def add_comment_to_ritm(ritm_sys_id, sql_text):
    """ç»™ RITM æ·»åŠ å¤šè¡Œ commentï¼ˆçœŸå®æ¢è¡Œï¼‰"""
    auto_comment = f"[Auto-SQL-Added]\n{sql_text}"

    payload = {
        "comments": auto_comment
    }

    # é¿å… \n è¢« escape
    body = json.dumps(payload, ensure_ascii=False).replace("\\n", "\n")

    url = f"{SN_INSTANCE}/api/now/table/sc_req_item/{ritm_sys_id}"

    resp = requests.patch(url, data=body, auth=(SN_USER, SN_PASS), headers=HEADERS)
    resp.raise_for_status()
    return True


def process_new_ritms():
    ritms = get_recent_ritms(hours=1)

    for r in ritms:
        sys_id = r["sys_id"]
        number = r["number"]

        # 1. æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è‡ªåŠ¨ comment
        if ritm_has_auto_comment(sys_id):
            print(f"ğŸ”µ å·²å¤„ç†è¿‡ {number}ï¼Œè·³è¿‡")
            continue

        # 2. ç”Ÿæˆä½ çš„ SQLï¼ˆè¿™é‡Œç›´æ¥ä¸¾ä¾‹ï¼‰
        sql_text = f"""
INSERT INTO ICEBERG_CATALOG.xxx (
 job_id,
 job_name
) VALUES (
 999,
 'test'
);
"""

        # 3. æ·»åŠ è¯„è®º
        add_comment_to_ritm(sys_id, sql_text)
        print(f"ğŸŸ¢ å·²ä¸º {number} æ·»åŠ  Auto SQL è¯„è®º")


if __name__ == "__main__":
    process_new_ritms()

ğŸ§  è¿™ä¸ªä»£ç åšåˆ°äº†ä»€ä¹ˆï¼Ÿ

âœ… æ¯æ¬¡è¿è¡Œåªå¤„ç†æœªå¤„ç†è¿‡çš„ RITM

âœ… é€šè¿‡ [Auto-SQL-Added] åˆ¤æ–­æ˜¯å¦å·²ç»åšè¿‡

âœ… comment é‡ŒçœŸå®æ¢è¡Œï¼ˆä¸ä¼šå‡ºç° \nï¼‰

âœ… SQL å¤šè¡Œå­—ç¬¦ä¸²æ ¼å¼å®Œæ•´

âœ… ä½ æ— éœ€ä¿®æ”¹ ServiceNow è¡¨ç»“æ„

ğŸŸ§ ä¸ºä»€ä¹ˆä½¿ç”¨ [Auto-SQL-Added] ä½œä¸ºæ ‡è®°ï¼Ÿ

å› ä¸ºï¼š
	â€¢	ä¸ä¾èµ–è‡ªå®šä¹‰å­—æ®µ
	â€¢	ä¸å½±å“ ServiceNow çš„çœŸå®ä¸šåŠ¡å­—æ®µ
	â€¢	å¤šæ¬¡è½®è¯¢å‘ˆç°å¹‚ç­‰è¡Œä¸º
	â€¢	comment å¯æœç´¢
	â€¢	ç®€å•å¯é 

å¦‚æœä½ æƒ³ï¼Œæˆ‘å¯ä»¥ï¼š
	â€¢	æ”¹ä¸ºç”¨ sys_tags
	â€¢	æˆ–è€…ç”¨ attachment
	â€¢	æˆ–è€…æŠŠâ€œå·²å¤„ç†æ¸…å•â€å­˜åˆ° DynamoDB / local sqlite / local file

çœ‹ä½ éœ€æ±‚ã€‚

ğŸ“© ä¸‹ä¸€æ­¥ï¼š

åªè¦ä½ ç»™æˆ‘ï¼š
	â€¢	ä½ å®é™…è¿‡æ»¤æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆæ¯”å¦‚ assignment_groupã€çŠ¶æ€ã€priority ç­‰ï¼‰
	â€¢	ä½ çš„ SQL æ˜¯æ€ä¹ˆç”Ÿæˆçš„ï¼ˆæˆ‘å¯ä»¥å¸®ä½ æ¨¡å—åŒ–ï¼‰

æˆ‘å¯ä»¥å¸®ä½ æŠŠè¿™æ®µä»£ç å®Œå…¨æ”¹æˆä½ ç”Ÿäº§å¯ç”¨çš„ç‰ˆæœ¬ã€‚
