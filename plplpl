ğŸ‘Œ å®Œå…¨ç†è§£äº†ã€‚

ä½ ç°åœ¨çš„æ‰§è¡Œå‡½æ•°ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯ï¼š

	è¿”å›ä¸€ä¸ªç»“æœï¼ˆæ¯”å¦‚å­—ç¬¦ä¸²æˆ–å¸ƒå°”å€¼ï¼‰æ¥è¡¨ç¤ºæˆåŠŸ/å¤±è´¥ï¼Œä¾‹å¦‚è¿”å› "OK" æˆ– "FAIL" æˆ– True / Falseã€‚

âœ… é‚£æˆ‘ä»¬å°±è¦è°ƒæ•´ retry é€»è¾‘å¦‚ä¸‹ï¼š

	â€¢	ä¸å†ç”¨ try...except åˆ¤æ–­æ˜¯å¦å¤±è´¥ï¼›
	â€¢	è€Œæ˜¯æ ¹æ®å‡½æ•°çš„ è¿”å›å€¼ï¼ˆå¦‚ 'FAIL'ï¼‰æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•ï¼›
	â€¢	æˆåŠŸç«‹å³è¿”å›ï¼Œå¤±è´¥è¿›å…¥ retry é€»è¾‘ï¼›
	â€¢	å’Œä½ åŸæ¥è®¾æƒ³çš„ count å¾ªç¯åŸºæœ¬ä¸€è‡´ï¼Œä½†åŠ ä¸Šå¯é€‰çš„ backoff æ”¯æŒã€‚

âœ… æ”¹è¿›åçš„ retry_run_query_by_result() å‡½æ•°

import time
from datetime import datetime

def retry_run_query_by_result(job_def, max_retries: int = 3, backoff: bool = True):
    def log(msg):
        print(f"[{datetime.now().strftime('%H:%M:%S')}] {msg}")

    # ç¬¬ä¸€æ¬¡æ‰§è¡Œ
    rendered_query = replace_placeholders(job_def.query_template)
    result = run_query_returning_status(rendered_query, job_def)

    if result == "OK":
        log(f"Job '{job_def.job_name}' succeeded.")
        return

    log(f"Job '{job_def.job_name}' failed on first attempt (return={result}).")

    # é‡è¯•é€»è¾‘
    for attempt in range(1, max_retries + 1):
        delay = (2 ** (attempt - 1)) if backoff else 1
        time.sleep(delay)

        rendered_query = replace_placeholders(job_def.query_template)
        result = run_query_returning_status(rendered_query, job_def)

        if result == "OK":
            log(f"Retry {attempt}: Job '{job_def.job_name}' succeeded.")
            return
        else:
            log(f"Retry {attempt} failed (return={result}).")

    log(f"Job '{job_def.job_name}' failed after {max_retries} retries (last return={result}).")

âœ… ç¤ºä¾‹æ‰§è¡Œå‡½æ•°ï¼ˆä½ å®é™…çš„æ‰§è¡Œé€»è¾‘ï¼‰ï¼š

ä½ åº”è¯¥æŠŠä½ çœŸæ­£çš„ query æ‰§è¡Œé€»è¾‘åŒ…è£…æˆå¦‚ä¸‹å‡½æ•°ï¼š

def run_query_returning_status(query: str, job_def) -> str:
    print(f"Executing SQL for job '{job_def.job_name}':\nâ†’ {query}")
    # è¿™é‡Œè¿”å› 'OK' è¡¨ç¤ºæˆåŠŸï¼Œå…¶ä»–å€¼è¡¨ç¤ºå¤±è´¥
    # ä½ å®é™…å¯ä»¥æ‰§è¡Œ SQL å¹¶åˆ†æç»“æœå†³å®šæˆåŠŸä¸å¦
    return "OK"  # or return "FAIL"

âœ… ä½¿ç”¨æ–¹å¼ï¼š

schedule.every(job_def.interval_minutes).minutes.do(
    retry_run_query_by_result, job_def=job_def
).tag(job_def.job_name)

âœ… è¾“å‡ºç¤ºä¾‹ï¼ˆè¿”å›å€¼æ§åˆ¶ï¼‰ï¼š

[14:15:00] Job 'job_1' failed on first attempt (return=FAIL).
[14:15:01] Retry 1 failed (return=FAIL).
[14:15:03] Retry 2: Job 'job_1' succeeded.

æˆ–

[14:17:00] Job 'job_2' succeeded.

âœ… æ€»ç»“ï¼šç°åœ¨ä½ æ‹¥æœ‰çš„é€»è¾‘æ˜¯

åŠŸèƒ½	çŠ¶æ€
æ ¹æ®è¿”å›å€¼åˆ¤æ–­æ˜¯å¦æˆåŠŸ	âœ… æ”¯æŒ 'OK' / 'FAIL' / è‡ªå®šä¹‰çŠ¶æ€ç 
æˆåŠŸç«‹å³é€€å‡º	âœ…
å¤±è´¥è‡ªåŠ¨é‡è¯•	âœ… æœ€å¤š max_retries æ¬¡
æ”¯æŒæŒ‡æ•°é€€é¿	âœ… é»˜è®¤å¼€å¯ï¼Œå¯è®¾ç½®å…³é—­
å®Œå…¨å…¼å®¹ä½ å½“å‰é€»è¾‘	âœ… ä¸ä¾èµ–å¼‚å¸¸æœºåˆ¶

å¦‚æœä½ è¿”å›çš„ä¸æ˜¯å­—ç¬¦ä¸²è€Œæ˜¯å¸ƒå°”å€¼ï¼ˆå¦‚ True/Falseï¼‰ï¼Œä¹Ÿå¯ä»¥è½»æ¾æ”¯æŒï¼š

if result is True: ...

ä½ è¦ä¸è¦æˆ‘ä¹Ÿæ”¹ä¸€ç‰ˆæ”¯æŒå¸ƒå°”å€¼è¿”å›çš„ï¼Ÿæˆ–è€…æƒ³åŠ â€œåªå¯¹æŸäº›çŠ¶æ€ç æ‰é‡è¯•â€ï¼Ÿå‘Šè¯‰æˆ‘å³å¯ã€‚
