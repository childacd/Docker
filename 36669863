å¯ä»¥çš„ï¼Œè¿™ä¸ªéœ€æ±‚ç”¨ AWS CLI + ä¸€ç‚¹ç‚¹ Shell å¾ˆé€‚åˆåš ðŸ‘
æˆ‘å¸®ä½ å†™ä¸€ä¸ª å¯ä»¥ç›´æŽ¥è·‘çš„ Bash è„šæœ¬ï¼Œä½ åªéœ€è¦æ”¹å‡ ä¸ªå˜é‡ï¼ˆTagã€Regionã€Profileï¼‰å°±è¡Œã€‚

æ€è·¯è¯´æ˜Žï¼ˆç®€å•ç‰ˆï¼‰
	1.	ç”¨ aws ec2 describe-instances æŒ‰ Tag è¿‡æ»¤å‡ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„å®žä¾‹ï¼Œæ‹¿åˆ°ï¼š
	â€¢	InstanceId
	â€¢	ImageIdï¼ˆAMI IDï¼‰
	2.	å¯¹æ¯ä¸ª AMI ID è°ƒç”¨ aws ec2 describe-images æ‹¿åˆ°ï¼š
	â€¢	AMI Name
	3.	ä»Ž AMI Name é‡Œç”¨æ­£åˆ™æŠŠæœ€åŽçš„ YYYY-MM-DD æŠ½å‡ºæ¥å½“æ—¥æœŸã€‚
	4.	æœ€åŽæŒ‰æ—¥æœŸæŽ’åºè¾“å‡ºä¸€ä¸ªè¡¨ã€‚

å®Œæ•´è„šæœ¬ç¤ºä¾‹

å‡è®¾ä½ æ˜¯ Bash çŽ¯å¢ƒï¼Œå¹¶ä¸”å·²ç»è£…å¥½ & é…ç½®å¥½ awscliã€‚

#!/usr/bin/env bash
set -euo pipefail

# ======= é…ç½®åŒºåŸŸ =======
TAG_KEY="YourTagKey"       # æ¯”å¦‚ "Role" æˆ– "Environment"
TAG_VALUE="YourTagValue"   # æ¯”å¦‚ "Prod"
REGION="ap-southeast-1"    # æ”¹æˆä½ ç”¨çš„ region
PROFILE="default"          # å¦‚æœ‰å¤šä¸ª profile å°±æ”¹æˆå¯¹åº”çš„
# =======================

echo ">>> Fetching instances with tag: ${TAG_KEY}=${TAG_VALUE} in ${REGION} ..."

# 1. æ‰¾åˆ°æ‰€æœ‰ç¬¦åˆ Tag çš„å®žä¾‹ï¼Œè¾“å‡ºï¼šInstanceId  ImageId
instances=$(
  aws ec2 describe-instances \
    --region "$REGION" \
    --profile "$PROFILE" \
    --filters "Name=tag:${TAG_KEY},Values=${TAG_VALUE}" \
    --query 'Reservations[].Instances[].[InstanceId, ImageId]' \
    --output text
)

if [[ -z "$instances" ]]; then
  echo "No instances found with tag ${TAG_KEY}=${TAG_VALUE}"
  exit 0
fi

# 2. é€ä¸ªå®žä¾‹æŸ¥å¯¹åº” AMI Nameï¼Œè§£æžå‡ºæ—¥æœŸåŽæŽ’åº
{
  # è¡¨å¤´
  printf "DATE\tINSTANCE_ID\tAMI_ID\tAMI_NAME\n"

  # å®žä¾‹åˆ—è¡¨é€è¡Œå¤„ç†
  while read -r instance_id ami_id; do
    # é˜²å¾¡æ€§åˆ¤æ–­
    [[ -z "$instance_id" || -z "$ami_id" ]] && continue

    # æŸ¥è¯¢ AMI Name
    ami_name=$(
      aws ec2 describe-images \
        --region "$REGION" \
        --profile "$PROFILE" \
        --image-ids "$ami_id" \
        --query 'Images[0].Name' \
        --output text
    )

    # ä»Ž AMI Name ä¸­æå–æœ€åŽçš„æ—¥æœŸåŽç¼€ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰
    # ä¾‹å¦‚ï¼šmy-app-prod-2025-09-12 -> 2025-09-12
    date_suffix=$(grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}$' <<< "$ami_name" || true)
    if [[ -z "$date_suffix" ]]; then
      date_suffix="N/A"
    fi

    # è¾“å‡ºä¸€è¡Œè®°å½•
    printf "%s\t%s\t%s\t%s\n" "$date_suffix" "$instance_id" "$ami_id" "$ami_name"

  done <<< "$instances" | sort -k1,1
} 

ä½¿ç”¨æ–¹å¼
	1.	æŠŠä¸Šé¢çš„å†…å®¹ä¿å­˜æˆä¸€ä¸ªè„šæœ¬ï¼Œæ¯”å¦‚ï¼šlist_ami_dates.sh
	2.	ä¿®æ”¹é¡¶éƒ¨çš„è¿™å‡ ä¸ªå˜é‡ï¼š

TAG_KEY="Environment"
TAG_VALUE="Prod"
REGION="ap-southeast-1"
PROFILE="default"        # å¦‚æžœä½ ç”¨çš„å°±æ˜¯é»˜è®¤ profile å°±ä¸ç”¨æ”¹


	3.	èµ‹äºˆæ‰§è¡Œæƒé™ï¼š

chmod +x list_ami_dates.sh


	4.	è¿è¡Œï¼š

./list_ami_dates.sh



è¾“å‡ºç¤ºä¾‹å¤§æ¦‚é•¿è¿™æ ·ï¼š

DATE        INSTANCE_ID      AMI_ID          AMI_NAME
2025-01-10  i-0123456789ab   ami-0aaaabbbb   my-app-prod-2025-01-10
2025-03-05  i-0abcde123456   ami-0cccdddde   my-app-prod-2025-03-05
2025-09-12  i-0fffff999999   ami-0ffffeeee   my-app-prod-2025-09-12
N/A         i-0xyzxyzxyzxy   ami-0123abcd    some-older-ami-without-date

	â€¢	å·²ç»æŒ‰ DATE å­—æ®µä»Žå°åˆ°å¤§æŽ’åºã€‚
	â€¢	å¦‚æžœæŸä¸ª AMI Name æ²¡æœ‰åŒ¹é…åˆ°æ—¥æœŸï¼Œå°±ä¼šæ˜¾ç¤ºä¸º N/Aã€‚

å¦‚æžœä½ æƒ³åªçœ‹æŒ‰æ—¥æœŸæŽ’åºå¥½çš„åˆ—è¡¨ï¼ˆä¸åœ¨ä¹Ž InstanceIdï¼‰

æŠŠ while é‡Œé‚£è¡Œæ”¹æˆåªæ‰“å°æ—¥æœŸ + AMI ä¿¡æ¯å°±è¡Œï¼Œæ¯”å¦‚ï¼š

printf "%s\t%s\n" "$date_suffix" "$ami_name"

å¦‚æžœä½ æ„¿æ„ï¼Œå¯ä»¥æŠŠä½ å®žé™…çš„ AMI Name ç¤ºä¾‹è´´ç»™æˆ‘ï¼Œæˆ‘å¯ä»¥å¸®ä½ æŠŠé‚£ä¸€æ®µæ­£åˆ™/æˆªå–é€»è¾‘å†™å¾—æ›´ç²¾ç¡®ä¸€ç‚¹ï¼ˆæ¯”å¦‚æœ‰ä¸‹åˆ’çº¿ã€å‰ç¼€å›ºå®šç­‰ï¼‰ã€‚


å¯ä»¥ï¼Œä¸€è¡Œå‘½ä»¤ + pipes å°±èƒ½å®Œæˆï¼ˆè™½ç„¶å¾ˆé•¿ ðŸ˜‚ï¼‰ã€‚
ä¸‹é¢ç»™ä½ ä¸€ä¸ª çœŸæ­£çš„ä¸€è¡Œå‘½ä»¤ï¼Œç›´æŽ¥è´´åˆ°ç»ˆç«¯å°±èƒ½è·‘ã€‚

âœ… ä¸€è¡Œå‘½ä»¤ç‰ˆæœ¬ï¼ˆæŒ‰ Tag æ‰¾å®žä¾‹ â†’ æŸ¥ AMI â†’ è§£æžæ—¥æœŸ â†’ æŽ’åºï¼‰

è¯·æŠŠ YourTagKeyã€YourTagValue å’Œ ap-southeast-1 æ”¹æˆä½ çš„å€¼ï¼š

aws ec2 describe-instances --region ap-southeast-1 --filters "Name=tag:YourTagKey,Values=YourTagValue" \
  --query 'Reservations[].Instances[].[InstanceId,ImageId]' --output text \
| while read iid ami; do \
    name=$(aws ec2 describe-images --image-ids "$ami" --region ap-southeast-1 --query "Images[0].Name" --output text); \
    date=$(echo "$name" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}$'); \
    echo -e "${date}\t${iid}\t${ami}\t${name}"; \
  done \
| sort -k1,1

ðŸ“ è¾“å‡ºç¤ºä¾‹

2025-01-10   i-0123456789   ami-0aaabbbccc   my-service-2025-01-10
2025-04-12   i-0abcabcabc   ami-0dddeeefff   my-service-2025-04-12
2025-09-12   i-0ffff12345   ami-0ffff99999   my-service-2025-09-12

ä¼šæŒ‰æ—¥æœŸå‡åºè‡ªåŠ¨æŽ’å¥½ã€‚

â­ æ›´çŸ­ä¸€ç‚¹çš„ï¼ˆåŽ»æŽ‰å¤šä½™ç¼©è¿›ï¼‰

ä½ ä¹Ÿå¯ä»¥ç”¨è¿™ç§æ ¼å¼ï¼Œç»ˆç«¯æ›´å¥½å¤åˆ¶ï¼š

aws ec2 describe-instances --region ap-southeast-1 --filters "Name=tag:YourTagKey,Values=YourTagValue" --query 'Reservations[].Instances[].[InstanceId,ImageId]' --output text \
| while read iid ami; do name=$(aws ec2 describe-images --image-ids $ami --region ap-southeast-1 --query "Images[0].Name" --output text); date=$(echo $name | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}$'); echo -e "$date\t$iid\t$ami\t$name"; done \
| sort -k1,1

âš™ï¸ å¦‚æžœä½ åšæŒâ€œç»å¯¹ä¸€æ¡å‘½ä»¤ï¼Œä¸ç”¨ whileâ€

æŠ€æœ¯ä¸Šä¹Ÿèƒ½åšåˆ°ï¼ˆç”¨ xargsï¼‰ï¼Œä½†è„šæœ¬å¯è¯»æ€§ä¼šéžå¸¸å·®ï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»™ä½ å†™ã€‚
å¦‚æžœä½ è¦ å®Œå…¨ä¸ç”¨ whileã€åªç”¨ pipe + xargs çš„ä¸€è¡Œç‰ˆï¼Œå‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥å†è¾“å‡ºæžé™ç²¾ç®€ç‰ˆã€‚
