éå¸¸èµï¼ä½ è¿™ä¸ªå†³ç­–éå¸¸åˆç†ã€‚

ä½ ç°åœ¨çš„è®¾è®¡æ€è·¯å°±å˜æˆï¼š
	â€¢	ğŸ“¦ API å±‚ç”¨ FastAPI
	â€¢	âš™ï¸ åº•å±‚é€šè¿‡æ‰§è¡Œ mc å‘½ä»¤ï¼ˆåŒ…å« mirror å’Œæ™®é€š copyï¼‰
	â€¢	âœ… å¥½å¤„ï¼š
	â€¢	å®ç° mirror éå¸¸ç®€å•
	â€¢	æ”¯æŒå•æ–‡ä»¶å’Œç›®å½•åŒæ­¥
	â€¢	MinIO å’Œ S3 éƒ½æ”¯æŒ
	â€¢	æ€§èƒ½ä¹Ÿå¾ˆå¥½ï¼ˆmc æ˜¯å®˜æ–¹é«˜æ•ˆåŒæ­¥å·¥å…·ï¼‰

âœ… API è®¾è®¡æ€è·¯

æˆ‘ä»¬å¯ä»¥æ”¯æŒä¸¤ä¸ªæ¨¡å¼ï¼š
	â€¢	å•æ–‡ä»¶ copyï¼šmc cp
	â€¢	ç›®å½•åŒæ­¥ mirrorï¼šmc mirror

ä½ ä¼ ä¸ªå‚æ•° mode=copy æˆ– mode=mirror å°±å¯ä»¥åˆ‡æ¢ã€‚

ğŸš€ å®Œæ•´ FastAPI + mc è°ƒç”¨ Demo

1. å®‰è£…ä¾èµ–

pip install fastapi uvicorn pydantic

2. Python ä»£ç 

import subprocess
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel

app = FastAPI()

# ä½ çš„ mc alias åç§° (æå‰é…ç½®å¥½)
S3_ALIAS = "s3"
MINIO_ALIAS = "minio"

class SyncRequest(BaseModel):
    from_path: str  # æ ¼å¼ï¼šs3/bucket/path æˆ– minio/bucket/path
    to_path: str    # æ ¼å¼ï¼šs3/bucket/path æˆ– minio/bucket/path
    mode: str = "copy"  # æ”¯æŒ copy æˆ– mirror

@app.post("/sync")
def sync_file(req: SyncRequest):
    try:
        if req.mode == "copy":
            command = ["mc", "cp", "--recursive", req.from_path, req.to_path]
        elif req.mode == "mirror":
            command = ["mc", "mirror", "--overwrite", req.from_path, req.to_path]
        else:
            raise HTTPException(status_code=400, detail="Unsupported mode. Use 'copy' or 'mirror'.")

        result = subprocess.run(command, capture_output=True, text=True)

        if result.returncode != 0:
            raise HTTPException(status_code=500, detail=result.stderr)

        return {
            "message": "Sync successful",
            "mode": req.mode,
            "from": req.from_path,
            "to": req.to_path,
            "stdout": result.stdout
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

3. å¯åŠ¨æœåŠ¡

uvicorn sync_api:app --host 0.0.0.0 --port 8000

4. ç¤ºä¾‹è¯·æ±‚

å•æ–‡ä»¶æ‹·è´

curl -X POST "http://<EC2-IP>:8000/sync" -H "Content-Type: application/json" -d '{
    "from_path": "s3/my-bucket/file.txt",
    "to_path": "minio/my-bucket/file.txt",
    "mode": "copy"
}'

ç›®å½• mirror

curl -X POST "http://<EC2-IP>:8000/sync" -H "Content-Type: application/json" -d '{
    "from_path": "s3/my-bucket/folder",
    "to_path": "minio/my-bucket/folder",
    "mode": "mirror"
}'

âœ… é‡ç‚¹æé†’
	â€¢	mc alias è¦äº‹å…ˆåœ¨ EC2 ä¸Šé…ç½®å¥½ï¼Œæ¯”å¦‚ï¼š

mc alias set s3 https://s3.amazonaws.com <access-key> <secret-key>
mc alias set minio http://minio-server:9000 minio-access-key minio-secret-key

	â€¢	EC2 ä¸Šç¡®ä¿ mc å¯æ‰§è¡Œï¼Œè·¯å¾„æ­£ç¡®
	â€¢	å¦‚æœä½ æƒ³è®© from_path å’Œ to_path ç›´æ¥ä¼  URLï¼ˆæ¯”å¦‚ s3://my-bucket/fileï¼‰ï¼Œä½ å¯ä»¥è‡ªå·±åšè§£æï¼Œç„¶åæ‹¼æˆ mc çš„è·¯å¾„ã€‚

âœ… åç»­å¯ä»¥æ‰©å±•
	â€¢	åŠ  token é‰´æƒ
	â€¢	æ”¯æŒ dry-run å‚æ•°
	â€¢	æ”¯æŒåŒæ­¥è¿›åº¦æŸ¥è¯¢ï¼ˆå¯ä»¥æ‰§è¡Œ mc mirror â€“watchï¼‰

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥å¸®ä½ å†™ï¼š
	â€¢	æ”¯æŒå‚æ•°æ£€æŸ¥ï¼ˆæ¯”å¦‚æ˜¯å¦å­˜åœ¨ï¼‰
	â€¢	æ”¯æŒ dry-run æ¨¡å¼ï¼ˆé¢„è§ˆåŒæ­¥å†…å®¹ï¼‰
	â€¢	æ”¯æŒåå°å¼‚æ­¥æ‰§è¡Œï¼ˆè§£å†³å¤§æ–‡ä»¶è¶…æ—¶é—®é¢˜ï¼‰

è¦å¸®ä½ åšè¿™äº›å—ï¼ŸğŸ˜Š
